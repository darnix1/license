#!/bin/bash

#Colores Instalador
msgi() {
    BLANCO='\033[1;37m' && ROJO='\e[1;31m' && VERDE='\e[32m' && AMARELO='\e[33m'
    AZUL='\e[34m' && MAGENTA='\e[35m' && MAG='\033[1;36m' && NEGRITA='\e[1m' && SINCOLOR='\e[0m'
    case $1 in
    -ne) cor="${ROJO}${NEGRITA}" && echo -ne "${cor}${2}${SINCOLOR}" ;;
    -ama) cor="${AMARELO}${NEGRITA}" && echo -e "${cor}${2}${SINCOLOR}" ;;
    -verm) cor="${AMARELO}${NEGRITA}[!] ${ROJO}" && echo -e "${cor}${2}${SINCOLOR}" ;;
    -azu) cor="${MAG}${NEGRITA}" && echo -e "${cor}${2}${SINCOLOR}" ;;
    -verd) cor="${VERDE}${NEGRITA}" && echo -e "${cor}${2}${SINCOLOR}" ;;
    -bra) cor="${ROJO}" && echo -ne "${cor}${2}${SINCOLOR}" ;;
    "-bar2" | "-bar") cor="${ROJO}════════════════════════════════════════════════════" && echo -e "${SINCOLOR}${cor}${SINCOLOR}" ;;
    esac
}
# ------- BARRA DE INTALL BASICO
# Versión larga (más lenta visualmente)
barra_intallb() {
  local comando="$1"
  # lanzar el comando directamente en background y capturar su PID
  eval "$comando" >/dev/null 2>&1 &
  local pid=$!

  # loop mientras el proceso exista
  while kill -0 "$pid" 2>/dev/null; do
    printf "  \033[1;33m["
    for ((i = 0; i < 40; i++)); do
      printf "\033[1;31m>"
      sleep 0.1
    done
    printf "\033[1;33m]"
    sleep 1
    printf "\n"
    tput cuu1 2>/dev/null && tput dl1 2>/dev/null
  done

  printf "  \033[1;33m[\033[1;31m%40s\033[1;33m] - \033[1;32m OK \033[0m\n" ">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>"
  sleep 1
}

# Versión corta (más rápida)
# Uso: barra_intall "comando_a_ejecutar" "nombre_del_paquete"
# Uso: barra_intall "comando" "nombre_del_paquete"
# Ejemplo: barra_intall "apt-get install -y htop" htop
barra_intall() {
  local comando="$1"
  local paquete="$2"

  # lanzar el comando en background y guardar su PID
  bash -c "$comando" >/dev/null 2>&1 &
  local cmdpid=$!

  # spinner que observa el PID dado
  spinner() {
    local -i i=0
    while kill -0 "$cmdpid" 2>/dev/null; do
      # barra corta de 20 pasos (puedes ajustar)
      printf "  \033[1;33m["
      for ((j = 0; j < 20; j++)); do
        printf "\033[1;31m>"
        sleep 0.04
      done
      printf "\033[1;33m]"
      sleep 0.4
      printf "\n"
      # retroceder una línea y borrarla (si tput falla, ignorar)
      tput cuu1 2>/dev/null && tput dl1 2>/dev/null
      ((i++))
      # preventive safety: si el spinner vive demasiado, aún así sigue comprobando kill -0
    done
  }

  # arrancar spinner en background y guardar su PID
  spinner &
  local spinner_pid=$!

  # esperar al comando real; wait devuelve su exit code
  wait "$cmdpid"
  local cmd_status=$?

  # detener el spinner (si sigue vivo)
  kill "$spinner_pid" 2>/dev/null || true
  # esperar a que el proceso del spinner termine para evitar zombies
  wait "$spinner_pid" 2>/dev/null || true

  # determinar estado: preferimos basarnos en el exit code del comando
  if [[ $cmd_status -eq 0 ]]; then
    # si además quieres comprobar que el paquete ahora existe:
    if [[ -n "$paquete" ]] && dpkg --get-selections 2>/dev/null | grep -wq "$paquete"; then
      ESTATUS=$'\033[1;33m       \033[1;32mINSTALADO'
    else
      ESTATUS=$'\033[1;33m       \033[1;32mOK (sin comprobación de paquete)'
    fi
  else
    ESTATUS=$'\033[91m  FALLO DE INSTALACION'
  fi

  printf "  \033[1;33m[\033[1;31m>>>>>>>>>>>>>>>>>>>>\033[1;33m] %b \033[0m\n" "$ESTATUS"
  sleep 0.3
}

# Ejemplo:
# barra_intall "apt-get update && apt-get install -y htop" htop
      
# ------- BARRA CENTRADORA
print_center() {
    if [[ -z $2 ]]; then
        text="$1"
    else
        col="$1"
        text="$2"
    fi

    while read line; do
        unset space
        x=$(((54 - ${#line}) / 2))
        for ((i = 0; i < $x; i++)); do
            space+=' '
        done
        space+="$line"
        if [[ -z $2 ]]; then
            msgi -azu "$space"
        else
            msgi "$col" "$space"
        fi
    done <<<$(echo -e "$text")
}
